<!DOCTYPE html>
<html>
<head>
    <script src="../library/phaser/dist/phaser.min.js"></script>
</head>
<body>

    <script>
    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 200 }
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update,
        },
        audio: {
            disableWebAudio: true
        }
    };

    var game = new Phaser.Game(config);
    var player;
    var music;
    var isActive;
    
    var keyMute;
    var keyMusicOn;
    var keyRight;
    var keyLeft;
    var keySpace;
    var keyLegRight;
    var keyLegLeft;
    var lastKey;
    
    var xPush=10;
    var xVelocity=0;
    var xVelocityLimit=300;
    var yPushIncrement=1;
    var yPush=0; 
    var yVelocity=0;
    var yPushDecrement=-0.5; 
    var yPushPositiveLimit=5;
    var yPushNegativeLimit=-5;
    var yVelocityLimit=100;
    var debug=true;
    var background;
    var backgroundY=0;

    function log(param){
        if(debug){
            console.log(param);
        }
    }

    function preload () {
        this.load.image('down', 'assets/background/down.jpg');
        this.load.image('upside', 'assets/background/upside.jpg');
        this.load.image('player', 'assets/player/bike1.png');
        this.load.image('blue', 'assets/effects/blue.png');
        this.load.audio('musictheme', ['assets/music/BossMain.ogg', 'assets/music/BossMain.wav']);
    }

    function create ()
    { 
        background = this.add.image(0, 0, 'upside'); 
        
        var particles = this.add.particles('blue');

        var emitter = particles.createEmitter({
            speed: 100,
            scale: { start: 1, end: 0 },
            blendMode: 'ADD'
        });

        player = this.physics.add.image(400, 10, 'player');

        player.setVelocity(xVelocity, yVelocity);
        player.setBounce(1, 1);
        player.setCollideWorldBounds(true);

        emitter.startFollow(player);
        music = this.sound.add('musictheme', { loop: true });
    
        //  Center the picture in the game
        Phaser.Display.Align.In.Center(background, this.add.zone(400, 300, 800, 600));
    
        //  Center the sprite to the picture
        Phaser.Display.Align.In.Center(player, background);
        
        music.play();
        
        isActive = true;
        
        keyMute = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.M);
        
        keyMusicOn = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.N);
        
        keyRight = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT);

        keyLeft = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT);

        keyLegLeft = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Q);

        keyLegRight = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
    
        keySpace = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

    }
    
function incrementYToggle(){
    yPush+=yPushIncrement;
} 
function incrementY(){
    yPush = yPush + yPushDecrement;
    if(yPush > yPushPositiveLimit){
        yPush = yPushPositiveLimit;
    }else if (yPush<yPushNegativeLimit){
        yPush = yPushNegativeLimit;
    }
    yVelocity=yVelocity-yPush 
    if(yVelocity>yVelocityLimit){
        yVelocity=yVelocityLimit;
    }else{
        if(yVelocity<(-yVelocityLimit)){
            yVelocity=-yVelocityLimit;
        }
    }
}

function updateBackground(){
    backgroundY=backgroundY+0.0005;
    //backgroundY=backgroundY + (yPush/1000);
    background.setOrigin(background.originX, backgroundY)
    log("backgroundY"+backgroundY);
    if(backgroundY>800){
        backgroundY=0;
    }
}
function keyActions(){
    if (keyRight.isDown)
    {
        if(xVelocity<xVelocityLimit){
            xVelocity=xVelocity+xPush;
        } 
    }

    if (keyLeft.isDown)
    {
        if(xVelocity>-xVelocityLimit){
            xVelocity=xVelocity-xPush;
        } 
    }

    if (keyLegLeft.isDown)
    {
        if(lastKey===keyLegRight){
            incrementYToggle();
            log('keyLegLeft '+yPush);
        }
        lastKey=keyLegLeft;
    }
    if (keyLegRight.isDown)
    {
        if(lastKey===keyLegLeft){
            incrementYToggle();
            log('keyLegRight '+yPush);
        }
        lastKey=keyLegRight;
    }
    if (keySpace.isDown)
    {
        log('keySpace');
    }
    if (keyMute.isDown)
    {
        if(music.isPlaying){
            music.pause();
        }
    }
    if (keyMusicOn.isDown)
    {
        if(!music.isPlaying){
            music.play();
        }
    }
}

function update() {
    keyActions(); 
    incrementY();
    log('velocityY '+ yVelocity + "pushY"+yPush);
    player.setVelocity(xVelocity, yVelocity);
    if(debug){
        music.pause();
    }
    updateBackground();
}

    
    </script>

</body>
</html>